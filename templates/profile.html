{% extends "base.html" %}

{% block title %}{{ profile_user }}'s Profile - PeopleConnects{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <!-- Profile Header -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="d-flex gap-3 w-100">
                        <!-- Profile Picture -->
                        <div>
                            {% if profile_pic %}
                                <img src="{{ profile_pic }}" alt="{{ profile_user }}" 
                                     class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
                            {% else %}
                                <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" 
                                     style="width: 100px; height: 100px;">
                                    <span class="text-white fs-1">{{ profile_user[0].upper() }}</span>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Profile Info -->
                        <div class="flex-grow-1">
                            <h2 class="mb-3">@{{ profile_user }}</h2>
                            <div class="d-flex gap-4">
                                <div>
                                    <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#followersModal">
                                        <strong>{{ followers_count }}</strong> <span class="text-muted">Followers</span>
                                    </a>
                                </div>
                                <div>
                                    <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#followingModal">
                                        <strong>{{ following_count }}</strong> <span class="text-muted">Following</span>
                                    </a>
                                </div>
                                <div>
                                    <strong>{{ posts|length }}</strong> <span class="text-muted">Posts</span>
                                </div>
                            </div>
                            
                            <!-- Profile Actions (own profile only) -->
                            {% if is_own_profile %}
                                <div class="mt-3 d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadPicModal">
                                        <i class="bi bi-camera"></i> Change Picture
                                    </button>
                                    <a href="/profile/edit" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-pencil"></i> Edit Profile
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Follow/Unfollow Button -->
                        {% if not is_own_profile %}
                            <div>
                                {% if is_following %}
                                    <form method="POST" action="/unfollow/{{ profile_user }}">
                                        <button type="submit" class="btn btn-outline-secondary">Unfollow</button>
                                    </form>
                                {% else %}
                                    <form method="POST" action="/follow/{{ profile_user }}">
                                        <button type="submit" class="btn btn-primary">Follow</button>
                                    </form>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Upload Profile Picture Modal -->
        {% if is_own_profile %}
        <div class="modal fade" id="uploadPicModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Upload Profile Picture</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form method="POST" action="/profile/upload-picture" enctype="multipart/form-data">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="profile_pic" class="form-label">Choose an image</label>
                                <input type="file" class="form-control" id="profile_pic" name="profile_pic" 
                                       accept="image/*" required>
                            </div>
                            <small class="text-muted">Supported formats: JPG, PNG, GIF, WebP</small>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Upload</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- User's Posts -->
        <h4 class="mb-3">Posts</h4>
        {% if posts %}
            {% for post in posts %}
            <div class="card mb-3">
                <div class="card-body">
                    <small class="text-muted">{{ post.timestamp.strftime('%B %d, %Y') }}</small>
                    <p class="mt-2">{{ post.content }}</p>
                    {% if post.image %}
                        <img src="{{ post.image }}" class="img-fluid rounded mb-2" alt="Post image" style="max-height: 300px; object-fit: cover;">
                    {% endif %}
                    <div class="d-flex gap-2 align-items-center">
                        <a href="/posts/{{ post.id }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-arrow-right"></i> View Details
                        </a>
                        <a href="/posts/{{ post.id }}" class="btn btn-sm btn-outline-danger d-flex align-items-center gap-1">
                            <i class="bi bi-heart"></i>
                            <span>{{ post.like_count }}</span>
                        </a>
                        <a href="/posts/{{ post.id }}#comments" class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1">
                            <i class="bi bi-chat"></i>
                            <span>{{ post.comment_count }}</span>
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">
                No posts yet.
            </div>
        {% endif %}
    </div>
</div>

<!-- Followers Modal -->
<div class="modal fade" id="followersModal" tabindex="-1" aria-labelledby="followersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="followersModalLabel"><i class="bi bi-people"></i> Followers ({{ followers_count }})</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if followers_list %}
                    <div class="list-group">
                        {% for follower in followers_list %}
                        <a href="/profile/{{ follower.username }}" class="list-group-item list-group-item-action d-flex align-items-center gap-3">
                            <!-- Follower Profile Picture -->
                            <div>
                                {% if follower.profile_pic %}
                                    <img src="{{ follower.profile_pic }}" alt="{{ follower.username }}" 
                                         class="rounded-circle" style="width: 48px; height: 48px; object-fit: cover;">
                                {% else %}
                                    <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" 
                                         style="width: 48px; height: 48px;">
                                        <span class="text-white fw-bold">{{ follower.username[0].upper() }}</span>
                                    </div>
                                {% endif %}
                            </div>
                            <!-- Follower Info -->
                            <div>
                                <h6 class="mb-0">@{{ follower.username }}</h6>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center py-4">No followers yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Following Modal -->
<div class="modal fade" id="followingModal" tabindex="-1" aria-labelledby="followingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="followingModalLabel"><i class="bi bi-person-check"></i> Following ({{ following_count }})</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if following_list %}
                    <div class="list-group">
                        {% for followed in following_list %}
                        <a href="/profile/{{ followed.username }}" class="list-group-item list-group-item-action d-flex align-items-center gap-3">
                            <!-- Following Profile Picture -->
                            <div>
                                {% if followed.profile_pic %}
                                    <img src="{{ followed.profile_pic }}" alt="{{ followed.username }}" 
                                         class="rounded-circle" style="width: 48px; height: 48px; object-fit: cover;">
                                {% else %}
                                    <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" 
                                         style="width: 48px; height: 48px;">
                                        <span class="text-white fw-bold">{{ followed.username[0].upper() }}</span>
                                    </div>
                                {% endif %}
                            </div>
                            <!-- Following Info -->
                            <div>
                                <h6 class="mb-0">@{{ followed.username }}</h6>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center py-4">Not following anyone yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}
